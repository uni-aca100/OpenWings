<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile</title>
  <link rel="stylesheet" href="/static/profile.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
</head>

<body>
  <header class="navbar">
    <div class="container flex items-center justify-between">
      <div class="brand"><a href="/" class="brand-link">Open Wings</a></div>
      <div><a href="/profile/logout" class="icon-link"><i class="fa-solid fa-right-from-bracket"></i></a></div>
    </div>
  </header>

  <!-- main contain a view one the bird searched/default -->
  <div class="wrap-content container">
    <main class="profile-view">
      <div class="profile-info grid gap-0">

        <div class="map-wrapper">
          <div id="map" class="obs-map"></div>
        </div>

        <div class="profile-meta-wrapper">
          <div class="profile-meta">
            <h1 class="user-name" id="js-username">...</h1>
            <div class="profile-foot"><em>Profile</em></div>
          </div>

          <div class="profile-actions">
            <!-- button open insert observation modal -->
            <button id="js-insert-observation" class="btn">Insert Observation</button>
            <!-- button open create new challenge modal -->
            <button id="js-create-challenge" class="btn">Create Challenge</button>
            <!-- button open invite user to a challenge modal -->
            <button id="js-invite-user" class="btn">Invite User</button>
          </div>

        </div>

      </div>
    </main>

    <!-- modal for inserting an observation -->
    <dialog id="js-insert-observation-modal" class="modal">
      <form method="dialog" class="modal-content">
        <button class="modal-close-btn" aria-label="Close">&times;</button>
        <h2 class="modal-title">Insert New Observation</h2>

        <div class="form-group">
          <label for="js-species-input">Species Scientific Name</label>
          <input type="text" id="js-species-input" name="species" required />
        </div>
        <div class="form-group">
          <label for="js-latitude-input">Latitude</label>
          <input type="number" step="any" id="js-latitude-input" name="latitude" required />
        </div>

        <div class="form-group">
          <label for="js-longitude-input">Longitude</label>
          <input type="number" step="any" id="js-longitude-input" name="longitude" required />
        </div>

        <div class="form-group">
          <label for="js-observed-at-input">Observed At</label>
          <input type="datetime-local" id="js-observed-at-input" name="observedAt" required />
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Submit Observation</button>
        </div>
      </form>
    </dialog>

    <!-- modal for creating a new challenge -->
    <dialog id="js-create-challenge-modal" class="modal">
      <form method="dialog" class="modal-content">
        <button class="modal-close-btn" aria-label="Close">&times;</button>
        <h2 class="modal-title">Create New Challenge</h2>

        <div class="form-group">
          <label for="js-challenge-name-input">Challenge Name</label>
          <input type="text" id="js-challenge-name-input" name="name" required />
        </div>
        <div class="form-group">
          <label for="js-challenge-start-date-input">Start Date</label>
          <input type="datetime-local" id="js-challenge-start-date-input" name="startDate" required />
        </div>

        <div class="form-group">
          <label for="js-challenge-end-date-input">End Date</label>
          <input type="datetime-local" id="js-challenge-end-date-input" name="endDate" required />
        </div>

        <div class="form-group">
          <label for="js-challenge-lc-points-input">Least Concern Points</label>
          <input type="number" step="any" id="js-challenge-lc-points-input" name="lcPoints" value="1" />
        </div>
        <div class="form-group">
          <label for="js-challenge-nt-points-input">Near Threatened Points</label>
          <input type="number" step="any" id="js-challenge-nt-points-input" name="ntPoints" value="2" />
        </div>
        <div class="form-group">
          <label for="js-challenge-vu-points-input">Vulnerable Points</label>
          <input type="number" step="any" id="js-challenge-vu-points-input" name="vuPoints" value="5" />
        </div>
        <div class="form-group">
          <label for="js-challenge-en-points-input">Endangered Points</label>
          <input type="number" step="any" id="js-challenge-en-points-input" name="enPoints" value="6" />
        </div>
        <div class="form-group">
          <label for="js-challenge-cr-points-input">Critically Endangered Points</label>
          <input type="number" step="any" id="js-challenge-cr-points-input" name="crPoints" value="8" />
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Create Challenge</button>
        </div>
      </form>
    </dialog>

    <!-- modal for inviting user to a challenge -->
    <dialog id="js-invite-user-modal" class="modal">
      <form method="dialog" class="modal-content">
        <button class="modal-close-btn" aria-label="Close">&times;</button>
        <h2 class="modal-title">Invite User to Challenge</h2>

        <div class="form-group">
          <label for="js-invite-challenge-input">Challenge name</label>
          <input type="text" id="js-invite-challenge-input" name="challenge" required />
        </div>

        <div class="form-group">
          <label for="js-invite-username-input">Username</label>
          <input type="text" id="js-invite-username-input" name="username" required />
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Send Invitation</button>
        </div>
      </form>
    </dialog>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
      /* leaflet setup */
      const map = L.map('map').setView([51.505, -0.09], 4);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);

      // Fetch GeoJSON data about observation points and update the map
      const observationPointsHandler = {
        lastLayer: null,

        fetchAndUpdateGeoJSON() {
          fetch('/api/user/observations', {
            method: 'POST'
          })
            .then(response => response.json())
            .then(data => {
              if (!data) {
                console.error('Invalid GeoJSON data received');
                return;
              }

              if (this.lastLayer) {
                map.removeLayer(this.lastLayer);
              }
              this.lastLayer = L.geoJSON(data, {
                onEachFeature: (feature, layer) => {
                  layer.bindPopup(`<em>species:</em> ${feature.properties.speciesName} <br />
                                   <em>approved:</em> ${feature.properties.approved} <br />
                                   <em>observed at:</em> ${new Date(feature.properties.observedAt).toLocaleDateString()}`);
                }
              });
              this.lastLayer.addTo(map);
            }).catch(error => {
              console.error('Error fetching observation points:', error);
            });
        }
      };

      // Fetch user information and update the profile display
      const userInfoHandler = {
        fetchAndUpdateUserInfo() {
          fetch('/api/user', {
            method: 'POST'
          })
            .then(response => response.json())
            .then(data => {
              document.getElementById('js-username').textContent = data.username;
            });
        }
      };

      const challengeListHandler = {
        fetchAndUpdateChallengeList() {
          // Placeholder for fetching and updating challenge list
          // Implementation depends on how challenges are displayed in the profile
        }
      };

      // Initialize the profile page information
      observationPointsHandler.fetchAndUpdateGeoJSON();
      userInfoHandler.fetchAndUpdateUserInfo();
      challengeListHandler.fetchAndUpdateChallengeList();

      // Modal handling for inserting new observation
      const insertObservationBtn = document.getElementById('js-insert-observation');
      const insertObservationModal = document.getElementById('js-insert-observation-modal');
      const modalCloseBtn = insertObservationModal.querySelector('.modal-close-btn');
      const observationForm = insertObservationModal.querySelector('form');

      insertObservationBtn.addEventListener('click', () => {
        insertObservationModal.showModal();
      });

      modalCloseBtn.addEventListener('click', (e) => {
        e.preventDefault();
        insertObservationModal.close();
      });

      observationForm.addEventListener('submit', (event) => {
        event.preventDefault();

        const formData = new FormData(observationForm);
        const observationData = {
          species: formData.get('species'),
          latitude: parseFloat(formData.get('latitude')),
          longitude: parseFloat(formData.get('longitude')),
          observedAt: new Date(formData.get('observedAt')).toISOString()
        };

        fetch('/api/user/observations/new', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(observationData)
        })
          .then(response => response.json())
          .then(data => {
            // Refresh the observation points on the map
            observationPointsHandler.fetchAndUpdateGeoJSON();
            // Close the modal
            insertObservationModal.close();
          })
          .catch(error => {
            console.error('Error submitting observation:', error);
          });
      });

      // Modal handling for creating new challenge
      const createChallengeBtn = document.getElementById('js-create-challenge');
      const createChallengeModal = document.getElementById('js-create-challenge-modal');
      const challengeModalCloseBtn = createChallengeModal.querySelector('.modal-close-btn');
      const challengeForm = createChallengeModal.querySelector('form');

      createChallengeBtn.addEventListener('click', () => {
        createChallengeModal.showModal();
      });

      challengeModalCloseBtn.addEventListener('click', (e) => {
        e.preventDefault();
        createChallengeModal.close();
      });

      challengeForm.addEventListener('submit', (event) => {
        event.preventDefault();

        const formData = new FormData(challengeForm);
        const challengeData = {
          name: formData.get('name'),
          startDate: new Date(formData.get('startDate')).toISOString(),
          endDate: new Date(formData.get('endDate')).toISOString(),
          points: {
            lc: parseFloat(formData.get('lcPoints')),
            nt: parseFloat(formData.get('ntPoints')),
            vu: parseFloat(formData.get('vuPoints')),
            en: parseFloat(formData.get('enPoints')),
            cr: parseFloat(formData.get('crPoints'))
          }
        };

        if (challengeData.startDate >= challengeData.endDate || Date.now() >= challengeData.endDate || Date.now() >= challengeData.startDate) {
          alert('Invalid date range for the challenge.');
          return;
        }

        fetch('/api/user/challenges/new', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(challengeData)
        })
          .then(response => response.json())
          .then(data => {
            // Refresh the challenge list
            challengeListHandler.fetchAndUpdateChallengeList();
            // Close the modal
            createChallengeModal.close();
          })
          .catch(error => {
            console.error('Error submitting challenge:', error);
          });
      });

      // Modal handling for inviting user to a challenge
      const inviteUserBtn = document.getElementById('js-invite-user');
      const inviteUserModal = document.getElementById('js-invite-user-modal');
      const inviteModalCloseBtn = inviteUserModal.querySelector('.modal-close-btn');
      const inviteForm = inviteUserModal.querySelector('form');

      inviteUserBtn.addEventListener('click', () => {
        inviteUserModal.showModal();
      });

      inviteModalCloseBtn.addEventListener('click', (e) => {
        e.preventDefault();
        inviteUserModal.close();
      });

      inviteForm.addEventListener('submit', (event) => {
        event.preventDefault();

        const formData = new FormData(inviteForm);
        const inviteData = {
          challenge: formData.get('challenge'),
          username: formData.get('username')
        };

        fetch('/api/user/challenges/invite', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(inviteData)
        })
          .then(response => response.json())
          .then(data => {
            // Handle successful invitation
            console.log('User invited successfully:', data);
            inviteUserModal.close();
          })
          .catch(error => {
            console.error('Error inviting user:', error);
          });
      });

    </script>
</body>

</html>