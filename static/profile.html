<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile</title>
  <link rel="stylesheet" href="/static/profile.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
</head>

<body>
  <header class="navbar">
    <div class="container flex items-center justify-between">
      <div class="brand"><a href="/" class="brand-link">Open Wings</a></div>
      <div class="icon-wrapper"><a href="/profile/logout" class="icon-link"><i
            class="fa-solid fa-right-from-bracket"></i></a></div>
    </div>
  </header>

  <!-- main contain a view one the bird searched/default -->
  <div class="wrap-content container">
    <main class="profile-view">
      <div class="profile-info grid gap-0">

        <div class="map-wrapper">
          <div id="map" class="obs-map"></div>
        </div>

        <div class="profile-meta-wrapper">
          <div class="profile-meta">
            <h1 class="user-name" id="js-username">...</h1>
            <div class="profile-foot"><em>Profile Actions</em></div>
          </div>

          <div class="profile-actions">
            <!-- button open insert observation modal -->
            <button id="js-insert-observation" class="btn btn-primary btn-actions">Insert Observation</button>
            <!-- button open create new challenge modal -->
            <button id="js-create-challenge" class="btn btn-primary btn-actions">Create Challenge</button>
            <!-- button open invite user to a challenge modal -->
            <button id="js-invite-user" class="btn btn-primary btn-actions">Invite User</button>
          </div>
        </div>
      </div>

      <div class="standings-wrapper" id="js-standings-wrapper">
        <!-- challenge standings will be dynamically loaded here -->
        <div>
          <h2>Ongoing Challenges</h2>
          <div class="standings-ongoing-wrapper" id="js-standings-ongoing-wrapper">
          </div>
        </div>
        <div>
          <h2>Ended Challenges</h2>
          <div class="standings-ended-wrapper" id="js-standings-ended-wrapper">
          </div>
        </div>
      </div>
    </main>

    <!-- modal for inserting an observation -->
    <dialog id="js-insert-observation-modal" class="modal">
      <form method="dialog" class="modal-content">
        <button class="modal-close-btn" aria-label="Close" type="button">&times;</button>
        <h2 class="modal-title">Insert New Observation</h2>

        <div class="form-group">
          <label for="js-species-input">Species Scientific Name</label>
          <input type="text" id="js-species-input" name="species" required />
        </div>
        <div class="form-group">
          <label for="js-latitude-input">Latitude</label>
          <input type="number" step="any" id="js-latitude-input" name="latitude" required />
        </div>

        <div class="form-group">
          <label for="js-longitude-input">Longitude</label>
          <input type="number" step="any" id="js-longitude-input" name="longitude" required />
        </div>

        <div class="form-group">
          <label for="js-observed-at-input">Observed At</label>
          <input type="datetime-local" id="js-observed-at-input" name="observedAt" required />
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Submit Observation</button>
        </div>
      </form>
    </dialog>

    <!-- modal for creating a new challenge -->
    <dialog id="js-create-challenge-modal" class="modal">
      <form method="dialog" class="modal-content">
        <button class="modal-close-btn" aria-label="Close" type="button">&times;</button>
        <h2 class="modal-title">Create New Challenge</h2>

        <div class="form-group">
          <label for="js-challenge-name-input">Challenge Name</label>
          <input type="text" id="js-challenge-name-input" name="name" required />
        </div>
        <div class="form-group">
          <label for="js-challenge-start-date-input">Start Date</label>
          <input type="datetime-local" id="js-challenge-start-date-input" name="startDate" required />
        </div>

        <div class="form-group">
          <label for="js-challenge-end-date-input">End Date</label>
          <input type="datetime-local" id="js-challenge-end-date-input" name="endDate" required />
        </div>

        <div class="form-group">
          <label for="js-challenge-lc-points-input">Least Concern Points</label>
          <input type="number" step="any" id="js-challenge-lc-points-input" name="lcPoints" value="1" />
        </div>
        <div class="form-group">
          <label for="js-challenge-nt-points-input">Near Threatened Points</label>
          <input type="number" step="any" id="js-challenge-nt-points-input" name="ntPoints" value="2" />
        </div>
        <div class="form-group">
          <label for="js-challenge-vu-points-input">Vulnerable Points</label>
          <input type="number" step="any" id="js-challenge-vu-points-input" name="vuPoints" value="5" />
        </div>
        <div class="form-group">
          <label for="js-challenge-en-points-input">Endangered Points</label>
          <input type="number" step="any" id="js-challenge-en-points-input" name="enPoints" value="6" />
        </div>
        <div class="form-group">
          <label for="js-challenge-cr-points-input">Critically Endangered Points</label>
          <input type="number" step="any" id="js-challenge-cr-points-input" name="crPoints" value="8" />
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Create Challenge</button>
        </div>
      </form>
    </dialog>

    <!-- modal for inviting user to a challenge -->
    <dialog id="js-invite-user-modal" class="modal">
      <form method="dialog" class="modal-content">
        <button class="modal-close-btn" aria-label="Close" type="button">&times;</button>
        <h2 class="modal-title">Invite User to Challenge</h2>

        <div class="form-group">
          <label for="js-invite-challenge-input">Challenge name</label>
          <input type="text" id="js-invite-challenge-input" name="challenge" required />
        </div>

        <div class="form-group">
          <label for="js-invite-username-input">Username</label>
          <input type="text" id="js-invite-username-input" name="username" required />
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Send Invitation</button>
        </div>
      </form>
    </dialog>

    <!-- challenge standings template -->
    <template id="js-challenge-standings-template">
      <article class="challenge-card" role="group" aria-labelledby="">
        <header class="challenge-header">
          <h3 class="challenge-name"></h3>
          <div class="challenge-meta">
            <!-- info about the challenge -->
            <time class="challenge-start-date" aria-label="Start date"></time>
            <span class="meta-separator">â€”</span>
            <time class="challenge-end-date" aria-label="End date"></time>
          </div>
        </header>

        <section class="standings-participants" aria-label="Participants standings">
          <div class="standings-participants-wrapper">
            <table class="participant-standings" role="table" aria-label="Participant standings">
              <thead>
                <tr>
                  <th scope="col" class="col-s col-th-user">User</th>
                  <th scope="col" class="col-s">Total</th>
                  <th scope="col" class="col-s" title="Least Concern">LC</th>
                  <th scope="col" class="col-s" title="Near Threatened">NT</th>
                  <th scope="col" class="col-s" title="Vulnerable">VU</th>
                  <th scope="col" class="col-s" title="Endangered">EN</th>
                  <th scope="col" class="col-s" title="Critically Endangered">CR</th>
                </tr>
              </thead>
              <tbody class="standings-body">
                <!-- participant standings will be dynamically loaded here -->
              </tbody>
            </table>
          </div>
        </section>
      </article>
    </template>

    <!-- participant standings template -->
    <template id="js-participant-standings-template">
      <tr class="participant-row">
        <td class="participant-username col-s" data-label="User"></td>
        <td class="participant-total-score col-s" data-label="Total"></td>
        <td class="participant-lc-score col-s" data-label="LC"></td>
        <td class="participant-nt-score col-s" data-label="NT"></td>
        <td class="participant-vu-score col-s" data-label="VU"></td>
        <td class="participant-en-score col-s" data-label="EN"></td>
        <td class="participant-cr-score col-s" data-label="CR"></td>
      </tr>
    </template>


    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
      /* leaflet setup */
      const map = L.map('map').setView([51.505, -0.09], 4);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);

      // Fetch GeoJSON data about observation points and update the map
      const observationPointsHandler = {
        lastLayer: null,

        fetchAndUpdateGeoJSON() {
          fetch('/api/user/observations', {
            method: 'POST'
          })
            .then(response => response.json())
            .then(data => {
              if (!data || data.error) {
                console.log('Invalid GeoJSON data received');
                return;
              }

              if (this.lastLayer) {
                map.removeLayer(this.lastLayer);
              }
              this.lastLayer = L.geoJSON(data, {
                onEachFeature: (feature, layer) => {
                  layer.bindPopup(`<em>species:</em> ${feature.properties.speciesName} <br />
                                   <em>approved:</em> ${feature.properties.approved} <br />
                                   <em>observed at:</em> ${new Date(feature.properties.observedAt).toLocaleDateString()}`);
                }
              });
              this.lastLayer.addTo(map);
            }).catch(error => {
              console.error('Error fetching observation points:', error);
            });
        }
      };

      // Fetch user information and update the profile display
      const userInfoHandler = {
        fetchAndUpdateUserInfo() {
          fetch('/api/user', {
            method: 'POST'
          })
            .then(response => response.json())
            .then(data => {
              document.getElementById('js-username').textContent = data.username;
            });
        },
      };

      const challengeListHandler = {
        fetchAndUpdateChallengeList() {
          fetch('/api/user/challenges', {
            method: 'POST'
          })
            .then(response => response.json())
            .then(data => {
              console.log('Challenge data received:', data);
              if (data && data.length > 0) {
                console.log('Inserting challenge standings...');
                this.insertChallengeStandings(data);
              } else {
                console.log('No challenges found for the user.');
              }
            }).catch(error => {
              console.error('Error fetching challenge list:', error);
            });
        },

        // handling the dynamic insertion of the challenge standings to the page
        // splitting the ongoing and ended challenges
        // and order the participants by total score descending
        insertChallengeStandings(data) {
          data.forEach(challenge => {
            challenge.participants.sort((a, b) => b.score - a.score);
          });
          const ongoing = document.getElementById('js-standings-ongoing-wrapper');
          const ended = document.getElementById('js-standings-ended-wrapper');
          ongoing.innerHTML = ''; // clear previous content
          ended.innerHTML = ''; // clear previous content
          this.insertChallengeStandingsToElement(data.filter(challenge => !challenge.ended), ongoing);
          this.insertChallengeStandingsToElement(data.filter(challenge => challenge.ended), ended);
        },

        // handling the dynamic insertion of the challenge standings to the given wrapper element
        insertChallengeStandingsToElement(data, standingsWrapper) {
          const challengeTemplate = document.getElementById('js-challenge-standings-template');
          const participantTemplate = document.getElementById('js-participant-standings-template');

          data.forEach(challenge => {
            const challengeClone = challengeTemplate.content.cloneNode(true);
            challengeClone.querySelector('.challenge-name').textContent = challenge.challengeName;
            challengeClone.querySelector('.challenge-start-date').textContent = new Date(challenge.startDate).toLocaleDateString();
            challengeClone.querySelector('.challenge-end-date').textContent = new Date(challenge.endDate).toLocaleDateString();
            const participantsWrapper = challengeClone.querySelector('.standings-body');

            challenge.participants.forEach(participant => {
              const participantClone = participantTemplate.content.cloneNode(true);
              participantClone.querySelector('.participant-username').textContent = participant.username;
              participantClone.querySelector('.participant-total-score').textContent = participant.score;
              participantClone.querySelector('.participant-lc-score').textContent = participant.lcScore;
              participantClone.querySelector('.participant-nt-score').textContent = participant.ntScore;
              participantClone.querySelector('.participant-vu-score').textContent = participant.vuScore;
              participantClone.querySelector('.participant-en-score').textContent = participant.enScore;
              participantClone.querySelector('.participant-cr-score').textContent = participant.crScore;
              participantsWrapper.appendChild(participantClone);
            });

            // append the challenge card after all participants are added
            standingsWrapper.appendChild(challengeClone);
          });

        }
      };

      // Initialize the profile page information
      observationPointsHandler.fetchAndUpdateGeoJSON();
      userInfoHandler.fetchAndUpdateUserInfo();
      challengeListHandler.fetchAndUpdateChallengeList();

      // Modal handling for inserting new observation
      const insertObservationBtn = document.getElementById('js-insert-observation');
      const insertObservationModal = document.getElementById('js-insert-observation-modal');
      const modalCloseBtn = insertObservationModal.querySelector('.modal-close-btn');
      const observationForm = insertObservationModal.querySelector('form');

      insertObservationBtn.addEventListener('click', () => {
        insertObservationModal.showModal();
      });

      modalCloseBtn.addEventListener('click', (e) => {
        e.preventDefault();
        insertObservationModal.close();
      });

      observationForm.addEventListener('submit', (event) => {
        event.preventDefault();

        const formData = new FormData(observationForm);
        const observationData = {
          species: formData.get('species'),
          latitude: parseFloat(formData.get('latitude')),
          longitude: parseFloat(formData.get('longitude')),
          observedAt: new Date(formData.get('observedAt')).toISOString()
        };

        fetch('/api/user/observations/new', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(observationData)
        })
          .then(response => response.json())
          .then(data => {
            // Refresh the observation points on the map
            observationPointsHandler.fetchAndUpdateGeoJSON();
            // Close the modal
            insertObservationModal.close();
          })
          .catch(error => {
            console.error('Error submitting observation:', error);
          });
      });

      // Modal handling for creating new challenge
      const createChallengeBtn = document.getElementById('js-create-challenge');
      const createChallengeModal = document.getElementById('js-create-challenge-modal');
      const challengeModalCloseBtn = createChallengeModal.querySelector('.modal-close-btn');
      const challengeForm = createChallengeModal.querySelector('form');

      createChallengeBtn.addEventListener('click', () => {
        createChallengeModal.showModal();
      });

      challengeModalCloseBtn.addEventListener('click', (e) => {
        e.preventDefault();
        createChallengeModal.close();
      });

      challengeForm.addEventListener('submit', (event) => {
        event.preventDefault();

        const formData = new FormData(challengeForm);
        const challengeData = {
          name: formData.get('name'),
          startDate: new Date(formData.get('startDate')).toISOString(),
          endDate: new Date(formData.get('endDate')).toISOString(),
          points: {
            lc: parseFloat(formData.get('lcPoints')),
            nt: parseFloat(formData.get('ntPoints')),
            vu: parseFloat(formData.get('vuPoints')),
            en: parseFloat(formData.get('enPoints')),
            cr: parseFloat(formData.get('crPoints'))
          }
        };

        if (challengeData.startDate >= challengeData.endDate || Date.now() >= challengeData.endDate || Date.now() >= challengeData.startDate) {
          alert('Invalid date range for the challenge.');
          return;
        }

        fetch('/api/user/challenges/new', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(challengeData)
        })
          .then(response => response.json())
          .then(data => {
            // Refresh the challenge list
            challengeListHandler.fetchAndUpdateChallengeList();
            // Close the modal
            createChallengeModal.close();
          })
          .catch(error => {
            console.error('Error submitting challenge:', error);
          });
      });

      // Modal handling for inviting user to a challenge
      const inviteUserBtn = document.getElementById('js-invite-user');
      const inviteUserModal = document.getElementById('js-invite-user-modal');
      const inviteModalCloseBtn = inviteUserModal.querySelector('.modal-close-btn');
      const inviteForm = inviteUserModal.querySelector('form');

      inviteUserBtn.addEventListener('click', () => {
        inviteUserModal.showModal();
      });

      inviteModalCloseBtn.addEventListener('click', (e) => {
        e.preventDefault();
        inviteUserModal.close();
      });

      inviteForm.addEventListener('submit', (event) => {
        event.preventDefault();

        const formData = new FormData(inviteForm);
        const inviteData = {
          challenge: formData.get('challenge'),
          username: formData.get('username')
        };

        fetch('/api/user/challenges/invite', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(inviteData)
        })
          .then(response => response.json())
          .then(data => {
            // Handle successful invitation
            console.log('User invited successfully:', data);
            inviteUserModal.close();
          })
          .catch(error => {
            console.error('Error inviting user:', error);
          });
      });

    </script>
</body>

</html>