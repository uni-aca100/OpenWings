<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>openWings</title>
  <link rel="stylesheet" href="/static/utils.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
</head>

<body>

  <header class="navbar">
    <div class="container flex items-center justify-between">
      <div class="brand"><a href="/" class="brand-link">Open Wings</a></div>
      <div class="nav-links flex">
        <div><button id="js-list-species-btn" class="btn btn-txt">Explore</button></div>
        <div class="icon-wrapper"><a href="/profile" class="icon-link"><i class="fa-solid fa-circle-user"></i></a></div>
      </div>
    </div>
  </header>

  <!-- main contain a view one the bird searched/default -->
  <div class="wrap-content container">
    <main class="bird-view">
      <div class="bird-info" id="js-bird-info">
        <div class="bird-title">
          <h1 class="common-name" id="js-common-name">Northern Pintail</h1>
          <div class="scientific-name" id="js-scientific-name"><em>Anas acuta</em></div>

          <!-- search bar -->
          <form id="js-search-bar" class="search-bar" role="search" aria-label="Search birds">
            <label for="js-search-input" class="sr-only">Search species</label>
            <div class="search-field" role="group" aria-labelledby="js-search-input">
              <input id="js-search-input" class="search-input" type="search" placeholder="e.g. Northern Pintail"
                aria-describedby="js-search-help" name="q" autocomplete="off" />
              <button id="js-search-btn" class="btn btn-search" type="submit">Search</button>
            </div>
            <div id="js-search-help" class="sr-only">Type a common or scientific name and press Enter or click Search
            </div>
          </form>

        </div>
        <div class="bird-meta-wrapper">
          <dl class="bird-meta" aria-labelledby="js-common-name">
            <div class="bird-meta-group">
              <dt>Family:</dt>
              <dd id="js-family">Anatidae</dd>
            </div>
            <div class="bird-meta-group">
              <dt>Order:</dt>
              <dd id="js-order">Anseriformes</dd>
            </div>
            <div class="bird-meta-group">
              <dt>Diet:</dt>
              <dd id="js-diet">Omnivore</dd>
            </div>
            <div class="bird-meta-group">
              <dt>Conservation:</dt>
              <dd id="js-conservation">Least Concern</dd>
            </div>
          </dl>
        </div>
      </div>
      <div class="grid bird-body-wrap" id="js-bird-body-wrap">
        <div class="bird-img1">
          <img class="bird-img" src="static/images/611-400x400-blur_2-grayscale.jpg" alt="Bird 1">
        </div>
        <div class="bird-img2">
          <img class="bird-img" src="static/images/611-400x400-blur_2-grayscale.jpg" alt="Bird 2">
        </div>
        <div class="bird-img3">
          <img class="bird-img" src="static/images/611-400x400-blur_2-grayscale.jpg" alt="Bird 3">
        </div>
        <div class="bird-img4">
          <img class="bird-img" src="static/images/611-400x400-blur_2-grayscale.jpg" alt="Bird 4">
        </div>
        <div class="bird-map-wrapper">
          <div id="map" class="bird-map"></div>

          <!-- season select button -->
          <div id="js-season-select" class="season-select" role="toolbar" aria-label="Select season">
            <button class="season-btn" type="button" data-season="nonbreeding" aria-label="Resident" title="resident">
              <img src="static/images/resident.png" class="season-icon" alt="resident" aria-hidden="true">
              <span class="sr-only">Resident</span>
            </button>
            <button class="season-btn" type="button" data-season="breeding" aria-label="Breeding" title="breeding">
              <img src="static/images/breeding.png" class="season-icon" alt="breeding" aria-hidden="true">
              <span class="sr-only">Breeding</span>
            </button>
            <button class="season-btn" type="button" data-season="postbreeding_migration"
              aria-label="Post-breeding Migration" title="postbreeding migration">
              <img src="static/images/postbreeding_migration.png" class="season-icon" alt="postbreeding migration"
                aria-hidden="true">
              <span class="sr-only">Post-breeding Migration</span>
            </button>
            <button class="season-btn" type="button" data-season="prebreeding_migration"
              aria-label="Rebreeding Migration" title="prebreeding migration">
              <img src="static/images/prebreeding_migration.png" class="season-icon" alt="prebreeding migration"
                aria-hidden="true">
              <span class="sr-only">Rebreeding Migration</span>
            </button>

          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- modal for listing (and selecting the species to search for) all the available species in the db -->
  <dialog id="js-list-species-modal" class="modal">
    <form method="dialog" class="modal-content">
      <button class="modal-close-btn" aria-label="Close" type="button">&times;</button>
      <h2 class="modal-title">List of Species</h2>

      <div class="form-group">
        <label for="js-species-select">please select a species</label>
        <select id="js-species-select" class="form-control" name="species-select">
          <!-- dynamically populated -->
        </select>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Search</button>
      </div>
    </form>
  </dialog>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="/static/entry.js"></script>
  <script>
    const listSpeciesBtn = document.getElementById('js-list-species-btn');
    const listSpeciesModal = document.getElementById('js-list-species-modal');
    const speciesSelect = document.getElementById('js-species-select');
    const listSpeciesForm = listSpeciesModal.querySelector('form');
    const listSpeciesCloseBtn = listSpeciesModal.querySelector('.modal-close-btn');

    // fetch an initial batch of species from the server and populate the select element
    function fetchSpecies() {
      fetch('/api/species/batch', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ limit: 50 }) // fetch up to 50 species
      }).then(response => response.json())
        .then(data => {
          data?.forEach(species => {
            const option = document.createElement('option');
            option.value = species.scientificName;
            option.textContent = `${species.commonName} (${species.scientificName})`;
            speciesSelect.appendChild(option);
          });
        })
        .catch(error => {
          console.error('Error fetching species list:', error);
        });
    }

    listSpeciesBtn.addEventListener('click', () => {
      listSpeciesModal.showModal();
      fetchSpecies(); // fetch species when the modal is opened
    });

    listSpeciesModal.addEventListener('close', (e) => {
      speciesSelect.innerHTML = ''; // clear the select element
    });

    listSpeciesCloseBtn.addEventListener('click', () => {
      listSpeciesModal.close();
    });

    listSpeciesForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const selectedSpecies = speciesSelect.value;
      if (selectedSpecies) {
        // set the search input value and trigger the search
        document.getElementById('js-search-input').value = selectedSpecies;
        document.getElementById('js-search-btn').click();
        listSpeciesModal.close();
      }
    });
  </script>

</body>

</html>